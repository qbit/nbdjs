From 20ba58d5bc06a6c95f511e61c3faffb8f1193850 Mon Sep 17 00:00:00 2001
From: Rasmus Andersson <rasmus@notion.se>
Date: Wed, 7 Jul 2010 22:03:07 +0200
Subject: [PATCH] Verifies SSL connections when passing root cert to "secure" option

---
 lib/irc.js |   14 +++++++++++++-
 1 files changed, 13 insertions(+), 1 deletions(-)

diff --git a/lib/irc.js b/lib/irc.js
index 85468f5..aea32c0 100644
--- a/lib/irc.js
+++ b/lib/irc.js
@@ -711,9 +711,21 @@ Client.prototype.connect = function ( retryCount ) { // {{{
     self.chans = {};
     self.conn = net.createConnection(self.opt.port, self.opt.server);
     if (self.opt.secure) {
+      // Set up a secure (SSL) connection
       if (typeof self.opt.secure !== 'object') {
-        // Will not verify the client upon ssl handshake
+        // Do not verify connection
         self.opt.secure = require('crypto').createCredentials({});
+      } else {
+        // Verify connection
+        self.conn.addListener("secure", function(){
+          if(!self.conn.verifyPeer()) {
+            if (self.opt.debug) {
+              sys.log('Warning: failed to verify SSL peer certificate'+
+                      ' -- aborting connection');
+            }
+            this.end();
+          }
+        });
       }
       self.conn.setSecure(self.opt.secure);
     }
-- 
1.7.0.4
